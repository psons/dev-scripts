#!/usr/bin/env python3

import frontmatter
import os
import sys
import argparse

# Configuration constants
DOCS_ROOT = 'docs'
PRIORITY_FILE = 'docs/dev/project-description.md'
OUTPUT_FILE = 'AGENTS.md'
COPILOT_OUTPUT_FILE = '.github/copilot-instructions.md'
COPILOT_CONTENT = """# AI Assistant Instructions

**For detailed project context and development guidelines, see [AGENTS.md](../../AGENTS.md) at the project root.**

This file is automatically loaded by GitHub Copilot when working in this repository. It references the centralized agent instructions to avoid duplication while ensuring both Copilot and other AI assistants have access to the same context.
"""

def get_metadata(filepath):
    """
    Parses a markdown file for YAML frontmatter.
    Falls back to file-based defaults if metadata is missing.
    """
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            post = frontmatter.load(f)
            return {
                "title": post.get('title', os.path.basename(filepath).replace('.md', '').title()),
                "status": post.get('status', 'Active'),
                "description": post.get('description', 'No description provided.'),
                "path": filepath
            }
    except Exception:
        return None

def index_knowledge():
    """Main execution logic to build the AGENTS.md file."""
    content = ["# AI Agent Knowledge Map\n"]
    content.append("> **Notice**: This file is automatically generated. Manual changes will be overwritten.\n")
    
    # Section 1: Core Project Context (Required Priority)
    if os.path.exists(PRIORITY_FILE):
        meta = get_metadata(PRIORITY_FILE)
        content.append("## Core Project Context")
        content.append(f"### {meta['title']}")
        content.append(f"- **Reference**: [{PRIORITY_FILE}](./{PRIORITY_FILE})")
        content.append(f"- **Summary**: {meta['description']}\n")
        content.append("---\n")
    
    # Section 2: Shared Knowledge (from KNOWLEDGE_HOME)
    knowledge_home = os.environ.get('KNOWLEDGE_HOME')
    if knowledge_home:
        shared_knowledge_file = os.path.join(knowledge_home, 'shared-knowledge.md')
        if os.path.exists(shared_knowledge_file):
            meta = get_metadata(shared_knowledge_file)
            if meta:
                content.append("## Shared Knowledge")
                content.append(f"### {meta['title']}")
                content.append(f"- **Reference**: [{shared_knowledge_file}]({shared_knowledge_file})")
                content.append(f"- **Summary**: {meta['description']}\n")
                content.append("---\n")
    
    content.append("## Document Registry")

    # Section 3: Recursive Discovery
    for root, _, files in os.walk(DOCS_ROOT):
        for file in sorted(files):
            if file.endswith('.md'):
                # Normalize path for Markdown compatibility
                full_path = os.path.join(root, file).replace("\\", "/")
                
                # Avoid duplicating the priority file
                if full_path == PRIORITY_FILE:
                    continue
                
                meta = get_metadata(full_path)
                if meta:
                    content.append(f"### {meta['title']}")
                    content.append(f"- **Status**: {meta['status']}")
                    content.append(f"- **Reference**: [{full_path}](./{full_path})")
                    content.append(f"- **Context**: {meta['description']}\n")

    # Final Write
    with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
        f.write("\n".join(content))

    print(f"Update Complete: {OUTPUT_FILE} generated.")

def create_copilot_instructions():
    """Create the .github/copilot-instructions.md file."""
    os.makedirs(os.path.dirname(COPILOT_OUTPUT_FILE), exist_ok=True)
    with open(COPILOT_OUTPUT_FILE, 'w', encoding='utf-8') as f:
        f.write(COPILOT_CONTENT)
    print(f"Update Complete: {COPILOT_OUTPUT_FILE} generated.")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Index knowledge files and generate AGENTS.md')
    parser.add_argument('--copilot', action='store_true', help='Create .github/copilot-instructions.md file')
    
    args = parser.parse_args()
    
    # Always generate the main index
    index_knowledge()
    
    # Generate copilot instructions if requested
    if args.copilot:
        create_copilot_instructions()
